//------------------------------------------------------
// THIS FILE IS AUTOGENERATED
// DO NOT APPLY MANUAL MODIFICATIONS IN THIS FILE!
//------------------------------------------------------

const sqlite3 = require("sqlite3").verbose();
const uuid = require('uuid');
const filepath = "./db/main.sqlite";


// get by id
async function getById(id, callback) {
    const db = new sqlite3.Database(filepath, (error) => {
        if (error) {return console.log(error.message);}
        db.serialize(() => {
            let result = {};
            console.log("employeesProvider->getById Started");
            db.each(`SELECT * FROM employees WHERE id = ?`, [id], (error, row) => {
                if (error) {return console.log(error);}
                let recordToReturn = 
				{
id: row.id,					firstName: row.firstName,
					lastName: row.lastName,
					email1: row.email1,
					phone1: row.phone1,
				}                
                result = recordToReturn;
            },
            function() {
                console.log("employeesProvider->getById Finished (callback)");
                callback(null, result);
            });
        });
    });
}


// list all
async function listAll(callback) {
    const db = new sqlite3.Database(filepath, (error) => {
        if (error) {return console.error(error.message);}
        db.serialize(() => {
            let result = [];
            console.log("employeesProvider->listall Started");
            db.each(`SELECT * FROM employees`, (error, row) => {
                if (error) {return console.log(error);}
                let newRecord = 
				{
id: row.id,					firstName: row.firstName,
					lastName: row.lastName,
					email1: row.email1,
					phone1: row.phone1,
				}                
                result.push(newRecord);
            },
            function() {
                console.log("employeesProvider->listAll Finished (result count:" + result.length + ")");
                callback(null, result);
            });
        });
    });
}


// save
async function save(params, callback) {
    const db = new sqlite3.Database(filepath, (error) => {
        if (error) {return console.error(error.message);}
        if (params.id > 0) {
            db.serialize(() => {
                console.log("employeesProvider->save(update) Started");
                db.prepare(`UPDATE employees SET firstName=?,lastName=?,email1=?,phone1=? WHERE id=?`, [params.firstName,params.lastName,params.email1,params.phone1,params.id]).run(
                    err => {
                        if (err != null) { db.close(); console.log(err.message) };
                    }
                    ).finalize(err => {
                        if (err != null) { db.close(); console.log(err.message) };
                    });
                db.close();
                console.log("employeesProvider->save(update) Finished");
                callback(null, "ok");
            });
        }
        else
        {
            db.serialize(() => {
                console.log("employeesProvider->save(insert) Started");
                const uniqueUUID = uuid.v4();
                console.log("Generated guid for new record: " + uniqueUUID);
                db.prepare(`INSERT INTO employees (firstName,lastName,email1,phone1, guid) VALUES (?,?,?,?, ?)`, [params.firstName,params.lastName,params.email1,params.phone1, uniqueUUID]).run(
                    err => {
                        if (err != null) { db.close(); console.log(err.message) };
                    }
                    ).finalize(err => {
                        if (err != null) { db.close(); console.log(err.message) };
                    });
                db.close();
                console.log("employeesProvider->save(insert) Finished");
                callback(null, "ok");
            });            
        }
    });
}


module.exports = { getById, listAll, save }